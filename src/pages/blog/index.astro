---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getPostSlug, getReadingTimeText, isPublished, sortPostsByDate } from '../../utils/blog';
import { withBase } from '../../config/site';

const allPosts = await getCollection('blog', ({ data }) => isPublished(data.draft));
const posts = sortPostsByDate(allPosts);
const tags = Array.from(new Set(posts.flatMap((post) => post.data.tags.map((tag) => tag.toLowerCase())))).sort();
---

<BaseLayout
  title="Blog"
  description="Security research notes, submission guidance, and coordination workflow insights."
  canonicalPath="/blog"
>
  <section class="max-w-4xl">
    <h1 class="font-display text-4xl font-bold">Blog</h1>
    <p class="mt-4 text-base leading-7 text-text-soft">
      Practical notes for researchers and stakeholders working through vulnerability submission, validation, and coordination.
    </p>
  </section>

  <section class="mt-8 card p-5">
    <label for="blog-search" class="text-sm font-semibold text-text">Search</label>
    <input
      id="blog-search"
      type="search"
      placeholder="Search by title or summary"
      class="mt-2 w-full rounded-xl border border-line bg-bg px-4 py-2.5 text-sm text-text"
    />

    <div class="mt-4 flex flex-wrap gap-2" aria-label="Tag filters">
      <button type="button" class="tag-filter rounded-full bg-brand px-3 py-1 text-xs font-semibold text-white" data-tag="all">All</button>
      {tags.map((tag) => (
        <button
          type="button"
          class="tag-filter rounded-full border border-line px-3 py-1 text-xs font-semibold text-text-soft"
          data-tag={tag}
        >
          #{tag}
        </button>
      ))}
    </div>
  </section>

  <section class="mt-6 grid gap-4" id="post-list">
    {posts.map((post) => (
      <article
        class="blog-card card p-6"
        data-tags={post.data.tags.map((tag) => tag.toLowerCase()).join(',')}
        data-title={post.data.title.toLowerCase()}
        data-summary={post.data.summary.toLowerCase()}
      >
        <div class="flex flex-wrap items-center gap-3 text-xs text-text-soft">
          <time datetime={post.data.date}>{new Date(post.data.date).toLocaleDateString('en-US', { dateStyle: 'medium' })}</time>
          <span>{getReadingTimeText(post.body)}</span>
        </div>
        <h2 class="mt-3 font-display text-2xl font-semibold">
          <a class="hover:text-brand" href={withBase(`/blog/${getPostSlug(post)}`)}>{post.data.title}</a>
        </h2>
        <p class="mt-3 text-sm leading-7 text-text-soft">{post.data.summary}</p>
        <div class="mt-4 flex flex-wrap gap-2 text-xs text-brand">
          {post.data.tags.map((tag) => <span>#{tag}</span>)}
        </div>
      </article>
    ))}
  </section>

  <p id="no-results" class="mt-6 hidden text-sm text-text-soft">No posts match your search.</p>

  <script is:inline>
    const searchInput = document.getElementById('blog-search');
    const tagButtons = document.querySelectorAll('.tag-filter');
    const cards = document.querySelectorAll('.blog-card');
    const noResults = document.getElementById('no-results');

    let activeTag = 'all';

    const applyFilters = () => {
      const query = (searchInput?.value || '').toLowerCase().trim();
      let visibleCount = 0;

      cards.forEach((card) => {
        const tags = card.dataset.tags || '';
        const title = card.dataset.title || '';
        const summary = card.dataset.summary || '';

        const matchTag = activeTag === 'all' || tags.split(',').includes(activeTag);
        const matchQuery = !query || title.includes(query) || summary.includes(query);
        const show = matchTag && matchQuery;

        card.classList.toggle('hidden', !show);
        if (show) visibleCount += 1;
      });

      noResults?.classList.toggle('hidden', visibleCount !== 0);
    };

    searchInput?.addEventListener('input', applyFilters);

    tagButtons.forEach((button) => {
      button.addEventListener('click', () => {
        activeTag = button.dataset.tag || 'all';
        tagButtons.forEach((b) => {
          const selected = b === button;
          b.classList.toggle('bg-brand', selected);
          b.classList.toggle('text-white', selected);
          b.classList.toggle('border', !selected);
          b.classList.toggle('border-line', !selected);
          b.classList.toggle('text-text-soft', !selected);
        });
        applyFilters();
      });
    });
  </script>
</BaseLayout>
