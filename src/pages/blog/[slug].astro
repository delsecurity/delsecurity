---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { getPostSlug, getReadingTimeText, isPublished, sortPostsByDate } from '../../utils/blog';
import { SITE, withBase } from '../../config/site';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => isPublished(data.draft));
  return posts.map((post) => ({
    params: { slug: getPostSlug(post) },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);
const allPosts = sortPostsByDate(await getCollection('blog', ({ data }) => isPublished(data.draft)));
const currentIndex = allPosts.findIndex((item) => item.id === post.id);
const previousPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;

const readingTime = getReadingTimeText(post.body);
const canonicalPath = `/blog/${getPostSlug(post)}`;
const canonical =
  post.data.canonical ??
  (import.meta.env.SITE ? new URL(withBase(canonicalPath), import.meta.env.SITE).toString() : undefined);
const articleJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.data.title,
  description: post.data.summary,
  datePublished: post.data.date,
  author: {
    '@type': 'Organization',
    name: SITE.name,
  },
  mainEntityOfPage: canonical,
};
---

<BaseLayout title={post.data.title} description={post.data.summary} canonicalPath={canonicalPath}>
  <article class="mx-auto max-w-3xl">
    <header class="mb-8 border-b border-line pb-6">
      <p class="text-xs font-semibold uppercase tracking-wide text-brand">Article</p>
      <h1 class="mt-3 font-display text-4xl font-bold leading-tight">{post.data.title}</h1>
      <div class="mt-4 flex flex-wrap gap-3 text-xs text-text-soft">
        <time datetime={post.data.date}
          >{new Date(post.data.date).toLocaleDateString('en-US', { dateStyle: 'medium' })}</time
        >
        <span>{readingTime}</span>
      </div>
      <div class="mt-4 flex flex-wrap gap-2 text-xs text-brand">
        {post.data.tags.map((tag) => <span>#{tag}</span>)}
      </div>
    </header>

    <div class="prose-shell prose prose-zinc max-w-none dark:prose-invert">
      <Content />
    </div>

    <nav class="mt-10 grid gap-4 border-t border-line pt-6 md:grid-cols-2" aria-label="Post navigation">
      <div>
        {previousPost && (
          <a class="card block p-4 hover:border-brand" href={withBase(`/blog/${getPostSlug(previousPost)}`)}>
            <p class="text-xs font-semibold uppercase tracking-wide text-text-soft">Previous</p>
            <p class="mt-1 font-display text-lg font-semibold text-text">{previousPost.data.title}</p>
          </a>
        )}
      </div>
      <div>
        {nextPost && (
          <a class="card block p-4 hover:border-brand" href={withBase(`/blog/${getPostSlug(nextPost)}`)}>
            <p class="text-xs font-semibold uppercase tracking-wide text-text-soft">Next</p>
            <p class="mt-1 font-display text-lg font-semibold text-text">{nextPost.data.title}</p>
          </a>
        )}
      </div>
    </nav>
  </article>

  <script is:inline type="application/ld+json" set:html={JSON.stringify(articleJsonLd)} />
</BaseLayout>
